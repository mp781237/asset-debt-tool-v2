<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ§“æ¡¿é©ç”¨åº¦è©•ä¼°å·¥å…·ï¼ˆAnderson å‚µå‹™è§€ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 text-slate-800">
  <div class="min-h-screen flex flex-col">
    <header class="bg-slate-900 text-white py-4 shadow">
      <div class="max-w-6xl mx-auto px-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div>
          <h1 class="text-xl font-semibold">æ§“æ¡¿é©ç”¨åº¦è©•ä¼°å·¥å…·v2.0</h1>
          <p class="text-sm text-slate-300">
            åƒè€ƒ Thomas J. Anderson çš„å‚µå‹™è§€ï¼Œç”¨å€‹äººåŒ–æ•¸å­—æª¢æŸ¥ï¼šè€ƒæ…®ä½¿ç”¨ä¿¡è²¸æŠ•è³‡æŒ‡æ•¸å‹ ETFï¼Œçµæ§‹ä¸Šæ˜¯å¦åœ¨å¯æ‰¿å—å€ã€‚
          </p>
        </div>
        <div class="text-xs sm:text-sm text-slate-300">
          æœ¬å·¥å…·åƒ…ç‚ºæ•™è‚²ç”¨é€”ï¼ŒéæŠ•è³‡æˆ–å€Ÿè²¸å»ºè­°ã€‚ By Rayçš„å­¸ç¿’ç­†è¨˜ https://vocus.cc/user/5ad17150fd89780001e2bcb4
        </div>
      </div>
    </header>

    <main class="flex-1 max-w-6xl mx-auto px-4 py-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- å·¦å´ï¼šè¼¸å…¥å€ -->
        <section class="lg:col-span-1 bg-white rounded-2xl shadow p-4 space-y-4">
          <h2 class="text-lg font-semibold mb-2">Step 1â€“5ï¼šè¼¸å…¥ä½ çš„æ¢ä»¶</h2>

          <!-- Step 1 -->
          <div class="space-y-2">
            <h3 class="font-medium text-slate-700 text-sm">
              <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-900 text-white text-xs mr-1">1</span>
              ç¾é‡‘æµï¼šå¹´è–ªèˆ‡æœˆæ”¯å‡º
            </h3>
            <p class="text-xs text-slate-500">
              é€™ä¸€æ­¥æ±ºå®šä½ çš„ã€Œç¾é‡‘æµå®‰å…¨æ„Ÿã€ï¼šé‚„å®Œæ‰€æœ‰å¿…è¦æ”¯å‡ºå¾Œï¼Œé‚„å‰©å¤šå°‘ç©ºé–“æ‰¿å—æ§“æ¡¿ã€‚
            </p>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">å¹´è–ªï¼ˆç¨…å‰ï¼‰</label>
              <input id="annualIncome" type="number" min="0" step="10000"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     placeholder="ä¾‹å¦‚ï¼š1200000" />
              <span class="text-sm">å…ƒ / å¹´</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">æœˆæ”¯å‡º</label>
              <input id="monthlyExpense" type="number" min="0" step="1000"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     placeholder="ä¾‹å¦‚ï¼š40000" />
              <span class="text-sm">å…ƒ / æœˆ</span>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="space-y-2 border-t pt-3">
            <h3 class="font-medium text-slate-700 text-sm">
              <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-900 text-white text-xs mr-1">2</span>
              å®‰å…¨ç·©è¡ï¼šæ—¢æœ‰è³‡ç”¢èˆ‡é å‚™é‡‘
            </h3>
            <p class="text-xs text-slate-500">
              é€™ä¸€æ­¥æœƒæŠŠä½ çš„è³‡ç”¢åˆ‡æˆå…©å€‹æ¡¶ï¼šå®‰å…¨æ¡¶ï¼ˆç·Šæ€¥é å‚™é‡‘ï¼‰èˆ‡é¢¨éšªæ¡¶ï¼ˆæŠ•è³‡ç”¨ï¼‰ã€‚å®‰å…¨æ¡¶ä¸åƒèˆ‡æ§“æ¡¿ã€‚
            </p>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">ç¾æœ‰æŠ•è³‡éƒ¨ä½</label>
              <input id="existingAssets" type="number" min="0" step="10000"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     placeholder="ä¾‹å¦‚ï¼š800000" />
              <span class="text-sm">å…ƒ</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">ç¾æœ‰é å‚™é‡‘</label>
              <input id="existingEmergency" type="number" min="0" step="10000"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     placeholder="ä¾‹å¦‚ï¼š200000" />
              <span class="text-sm">å…ƒ</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">é å‚™é‡‘ç›®æ¨™</label>
              <input id="emergencyMonths" type="number" min="0" step="1"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     placeholder="ä¾‹å¦‚ï¼š6" />
              <span class="text-sm">å€‹æœˆæ”¯å‡º</span>
            </div>
            <p id="emergencyTargetInfo"
               class="text-xs text-emerald-700 bg-emerald-50 rounded px-2 py-1 leading-relaxed">
              è«‹å…ˆè¼¸å…¥ã€Œæœˆæ”¯å‡ºã€èˆ‡ã€Œé å‚™é‡‘ç›®æ¨™æœˆæ•¸ã€ï¼Œé€™è£¡æœƒå¹«ä½ ç®—å‡ºéœ€è¦æº–å‚™çš„ç·Šæ€¥é å‚™é‡‘ç¸½é¡ã€‚
            </p>
          </div>

          <!-- Step 3 -->
          <div class="space-y-2 border-t pt-3">
            <h3 class="font-medium text-slate-700 text-sm">
              <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-900 text-white text-xs mr-1">3</span>
              æ§“æ¡¿è¨­å®šï¼šä¿¡è²¸é¡åº¦èˆ‡æ¢ä»¶
            </h3>
            <p class="text-xs text-slate-500">
              é€™æ˜¯ã€Œè² å‚µé‚£ä¸€å´ã€çš„è¨­è¨ˆã€‚å³ä½¿åˆ©ç‡ä½ï¼Œä½†é‡‘é¡èˆ‡å¹´é™è‹¥æŠ“å¾—å¤ªæ¿€é€²ï¼Œä»å¯èƒ½æ»‘å‘å£“è¿«æ€§å‚µå‹™ã€‚
            </p>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">å€Ÿæ¬¾é¡åº¦</label>
              <input id="loanAmount" type="number" min="0" step="10000"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     placeholder="ä¾‹å¦‚ï¼š1000000" />
              <span class="text-sm">å…ƒ</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">å€Ÿæ¬¾åˆ©ç‡</label>
              <input id="loanRate" type="number" min="0" step="0.1"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     value="2.1" />
              <span class="text-sm">% / å¹´</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">å€Ÿæ¬¾å¹´é™</label>
              <input id="loanYears" type="number" min="1" step="1"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     placeholder="ä¾‹å¦‚ï¼š7" />
              <span class="text-sm">å¹´ï¼ˆæœ¬åˆ©æ”¤é‚„ï¼‰</span>
            </div>
            <p id="monthlyPaymentInfo"
               class="text-xs text-sky-700 bg-sky-50 rounded px-2 py-1 leading-relaxed">
              è«‹å…ˆè¼¸å…¥ã€Œå€Ÿæ¬¾é¡åº¦ã€åˆ©ç‡èˆ‡å¹´é™ã€ï¼Œé€™è£¡æœƒé¡¯ç¤ºé ä¼°æ¯æœˆæœ¬åˆ©æ”¤é‚„é‡‘é¡ã€‚
            </p>
          </div>

          <!-- Step 4 -->
          <div class="space-y-2 border-t pt-3">
            <h3 class="font-medium text-slate-700 text-sm">
              <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-900 text-white text-xs mr-1">4</span>
              æŠ•è³‡è¨­å®šï¼šæ¨™çš„èˆ‡å ±é…¬å‡è¨­
            </h3>
            <p class="text-xs text-slate-500">
              é€™è£¡ä¸æ˜¯é æ¸¬å¸‚å ´ï¼Œè€Œæ˜¯è®“ä½ å¯«å‡ºå¿ƒä¸­çš„ã€Œæ¨‚è§€ï¼ä¸­æ€§ï¼æ‚²è§€ã€å ±é…¬ï¼Œçœ‹çœ‹åœ¨ä¸åŒå‡è¨­ä¸‹è³‡ç”¢è² å‚µè¡¨æœƒè®Šæˆä»€éº¼æ¨£å­ã€‚
            </p>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">æ¨™çš„åç¨±</label>
              <input id="assetName" type="text"
                     class="flex-1 border rounded px-2 py-1"
                     placeholder="ä¾‹å¦‚ï¼šVTI / SPY / VT" />
            </div>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">æ¨‚è§€å¹´åŒ–</label>
              <input id="optimisticReturn" type="number" step="0.5"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     value="10" />
            <span class="text-sm">% / å¹´</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">ä¸­æ€§å¹´åŒ–</label>
              <input id="baseReturn" type="number" step="0.5"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     value="6" />
              <span class="text-sm">% / å¹´</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">æ‚²è§€å¹´åŒ–</label>
              <input id="pessimisticReturn" type="number" step="0.5"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     value="0" />
              <span class="text-sm">% / å¹´</span>
            </div>
          </div>

          <!-- Step 5 -->
          <div class="space-y-2 border-t pt-3">
            <h3 class="font-medium text-slate-700 text-sm">
              <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-900 text-white text-xs mr-1">5</span>
              æ¨¡æ“¬æœŸé–“
            </h3>
            <p class="text-xs text-slate-500">
              æ¨¡æ“¬å¹´æ•¸è¶Šé•·ï¼Œè¶Šèƒ½çœ‹å‡ºæ§“æ¡¿åœ¨æ•´å€‹äººç”Ÿé€±æœŸä¸­çš„å½±éŸ¿ï¼Œä½†ä¹Ÿè¦è¨˜å¾—ï¼šè¶Šé•·æœŸï¼Œç¾å¯¦èµ°å‹¢è¶Šä¸å¯èƒ½å®Œå…¨ç…§åŠ‡æœ¬ã€‚
            </p>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">æ¨¡æ“¬å¹´æ•¸</label>
              <input id="horizonYears" type="number" min="1" max="100" step="1"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     value="30" />
              <span class="text-sm">å¹´</span>
            </div>
            <!-- æ–°å¢ï¼šæ¯å¹´è¿½åŠ æŠ•å…¥ -->
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm">æ¯å¹´è¿½åŠ æŠ•å…¥</label>
              <input id="annualContribution" type="number" min="0" step="10000"
                     class="flex-1 border rounded px-2 py-1 text-right"
                     placeholder="ä¾‹å¦‚ï¼š120000" />
              <span class="text-sm">å…ƒ / å¹´ï¼ˆé¸å¡«ï¼‰</span>
            </div>
          </div>

          <!-- æŒ‰éˆ• -->
          <div class="pt-3 flex gap-3">
            <button id="exampleButton"
                    class="flex-1 bg-emerald-600 text-white rounded-xl py-2 text-sm font-medium hover:bg-emerald-700 transition">
              ç¯„ä¾‹è³‡æ–™
            </button>
            <button id="runButton"
                    class="flex-1 bg-slate-900 text-white rounded-xl py-2 text-sm font-medium hover:bg-slate-800 transition">
              åŸ·è¡Œæ¨¡æ“¬
            </button>
            <button id="resetButton"
                    class="px-4 py-2 text-sm border rounded-xl text-slate-600 hover:bg-slate-50 transition">
              æ¸…ç©º
            </button>
          </div>
        </section>

        <!-- å³å´ï¼šçµæœèˆ‡èªªæ˜ -->
        <section class="lg:col-span-2 space-y-4">
          <!-- Anderson å‚µå‹™è§€èªªæ˜ -->
          <div id="conceptPanel" class="bg-slate-900 text-slate-100 rounded-2xl shadow p-4">
            <h2 class="text-lg font-semibold mb-2">Anderson å‚µå‹™è§€å³æ™‚è§£è®€</h2>
            <div id="conceptContent" class="space-y-2 text-sm">
              <p>
                å·¦é‚Šè¼¸å…¥çš„æ˜¯ä½ çš„æ•¸å­—ï¼Œé€™è£¡æœƒç”¨ Anderson çš„ä¸‰ç¨®å‚µå‹™èªè¨€ï¼Œå¹«ä½ ç¿»è­¯é€™ç­†ä¿¡è²¸ç›®å‰æ¯”è¼ƒæ¥è¿‘å“ªä¸€ç¨®ç‹€æ…‹ï¼š
              </p>
              <ul class="list-disc ml-5 space-y-1 text-xs text-slate-200">
                <li><span class="font-medium">å£“è¿«æ€§å‚µå‹™ï¼š</span>åˆ©æ¯åƒæ‰ç¾é‡‘æµã€æ²’æœ‰è³‡ç”¢æˆ–æµå‹•æ€§æ”¯æ’ï¼Œæ˜¯å„ªå…ˆæ¸…é™¤çš„å°è±¡ã€‚</li>
                <li><span class="font-medium">å·¥ä½œæ€§å‚µå‹™ï¼š</span>åƒæˆ¿è²¸ã€å­¸è²¸ï¼Œæœ‰è³‡ç”¢æˆ–äººåŠ›è³‡æœ¬æ”¯æ’ï¼Œè®“ä½ åœ¨äººç”Ÿæ™‚é–“è»¸ä¸Šã€Œå…ˆåšå†æ…¢æ…¢ä»˜ã€ã€‚</li>
                <li><span class="font-medium">å¢å€¼æ€§å‚µå‹™ï¼š</span>åœ¨ç¾é‡‘æµç©©ã€é å‚™é‡‘è¶³ã€è³‡ç”¢è² å‚µè¡¨å¥åº·çš„å‰æä¸‹ï¼Œç”¨å°éƒ¨åˆ†ä½åˆ©å‚µå‹™æ›å–çµæ§‹å„ªå‹¢ï¼ˆç¨…å‹™ã€æµå‹•æ€§ã€é¢¨éšªåˆ†æ•£ï¼‰ã€‚</li>
              </ul>
              <p class="text-xs text-slate-300 mt-2">
                å…ˆè·‘ä¸€æ¬¡æ¨¡æ“¬ï¼Œé€™è£¡å°±æœƒæ ¹æ“šä½ çš„ DSRã€ç·Šæ€¥é å‚™é‡‘èˆ‡æ§“æ¡¿æ¯”ï¼Œæè¿°ã€Œé€™ç­†ä¿¡è²¸æ¯”è¼ƒåƒå“ªä¸€å€ã€ã€‚
              </p>
            </div>
          </div>

          <!-- è©³ç´°æŒ‡æ¨™èˆ‡èªªæ˜ -->
          <div class="bg-white rounded-2xl shadow p-4">
            <h2 class="text-lg font-semibold mb-2">è©³ç´°æŒ‡æ¨™èˆ‡æ–‡å­—èªªæ˜</h2>
            <div id="detailsPanel" class="space-y-2 text-sm text-slate-700">
              <p class="text-slate-500">
                è«‹å¾ Step 1 é–‹å§‹ä¾åºå¡«å¯«ï¼Œå®Œæˆå¾Œé»ã€ŒåŸ·è¡Œæ¨¡æ“¬ã€ï¼Œæˆ–é»ã€Œç¯„ä¾‹è³‡æ–™ã€å¿«é€Ÿé«”é©—ã€‚
              </p>
            </div>
          </div>

          <!-- çµ±è¨ˆæ¦‚æ³ -->
          <div class="bg-white rounded-2xl shadow p-4">
            <h2 class="text-lg font-semibold mb-2">æ•´é«”ç‹€æ³ç¸½è¦½ï¼ˆç•¶ä¸‹çµæ§‹ï¼‰</h2>
            <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"></div>
            <p class="mt-3 text-xs text-slate-500">
              æé†’ï¼šçµæœå®Œå…¨å–æ±ºæ–¼ä½ çš„è¼¸å…¥å‡è¨­ï¼Œåƒ…ç”¨ä¾†æª¢æŸ¥çµæ§‹æ˜¯å¦åå‘ Anderson çš„ã€Œå·¥ä½œæ€§ï¼å¢å€¼æ€§å‚µå‹™ã€ï¼Œè€Œéä¿è­‰æˆåŠŸã€‚
            </p>
          </div>

          <!-- æ·¨è³‡ç”¢èµ°å‹¢åœ– -->
          <div class="bg-white rounded-2xl shadow p-4">
            <h2 class="text-lg font-semibold mb-2">æ·¨è³‡ç”¢èµ°å‹¢æ¨¡æ“¬ï¼ˆä¸‰ç¨®æƒ…å¢ƒï¼‰</h2>
            <div class="h-80">
              <canvas id="netWorthChart"></canvas>
            </div>
            <p id="chartNote" class="mt-2 text-xs text-slate-500"></p>
          </div>

          <!-- è³‡ç”¢è² å‚µè¡¨å¿«ç…§ -->
          <div class="bg-white rounded-2xl shadow p-4">
            <h2 class="text-lg font-semibold mb-2">è³‡ç”¢è² å‚µè¡¨å¿«ç…§ï¼ˆä¸­æ€§æƒ…å¢ƒï¼‰</h2>
            <p class="text-xs text-slate-500 mb-2">
              é€™è£¡ç”¨ä½ è¨­å®šçš„ã€Œä¸­æ€§å¹´åŒ–å ±é…¬ã€ä¾†æ¯”è¼ƒï¼šèµ·é» vs æ¨¡æ“¬æœ«å¹´ï¼Œè³‡ç”¢èˆ‡è² å‚µå„è‡ªé•·æˆä»€éº¼æ¨£å­ã€‚
              å®‰å…¨æ¡¶ï¼ˆé å‚™é‡‘ï¼‰ä¸è·Ÿè‘—è¡Œæƒ…æš´æ¼²æš´è·Œï¼Œé¢¨éšªæ¡¶ï¼ˆæŠ•è³‡è³‡ç”¢ï¼‰æ‰æœƒæ”¾å¤§æˆ–ç¸®æ°´ã€‚
              è‹¥é å‚™é‡‘ä¸è¶³ï¼Œä»å¯ç”¨æŠ•è³‡éƒ¨ä½æ”¯æ‡‰çŸ­æœŸéœ€æ±‚ï¼Œä½†å¯èƒ½å¿…é ˆåœ¨ä¸åˆ©æ™‚é»è³£å‡ºï¼Œé€ æˆæå¤±ã€‚
            </p>
            <div id="balancePanel" class="overflow-x-auto text-sm text-slate-700">
              <p class="text-sm text-slate-500">
                èª¿æ•´å·¦å´æ•¸å­—ä¸¦åŸ·è¡Œæ¨¡æ“¬å¾Œï¼Œé€™è£¡æœƒé¡¯ç¤ºä¸­æ€§æƒ…å¢ƒçš„è³‡ç”¢è² å‚µè¡¨å¿«ç…§ã€‚
              </p>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="py-4 text-center text-xs text-slate-500">
      æœ¬å·¥å…·åƒ…ç‚ºæ•™è‚²ç”¨é€”ï¼Œè«‹å‹¿è¦–ç‚ºæŠ•è³‡æˆ–å€Ÿè²¸å»ºè­°ã€‚å¯¦éš›æ±ºç­–è«‹è‡ªè¡Œè©•ä¼°æˆ–æ´½è©¢å°ˆæ¥­äººå£«ã€‚
    </footer>
  </div>

  <script>
    const MAX_YEARS = 100;
    let chartInstance = null;

    function getNumberValue(id) {
      const el = document.getElementById(id);
      if (!el) return 0;
      const v = parseFloat(el.value);
      return isNaN(v) ? 0 : v;
    }

    function calcMonthlyPayment(principal, annualRate, years) {
      const r = annualRate / 100 / 12;
      const n = years * 12;
      if (n <= 0) return 0;
      if (r === 0) return principal / n;
      return principal * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
    }

    function loanOutstanding(principal, annualRate, years, yearIndex, monthlyPayment) {
      const r = annualRate / 100 / 12;
      const n = years * 12;
      const k = Math.min(yearIndex * 12, n);

      if (k <= 0) return principal;
      if (r === 0) {
        const repaid = monthlyPayment * k;
        return Math.max(0, principal - repaid);
      }

      const factor = Math.pow(1 + r, k);
      const balance = principal * factor - monthlyPayment * (factor - 1) / r;
      return Math.max(0, balance);
    }

    // å®‰å…¨æ¡¶ï¼šç¾æœ‰é å‚™é‡‘+æ¯å¹´å‰©é¤˜é‡‘æµï¼›é¢¨éšªæ¡¶ï¼šç¾æœ‰æŠ•è³‡éƒ¨ä½ + å€Ÿæ¬¾é¡åº¦ + æ¯å¹´è¿½åŠ æŠ•å…¥
    function simulateNetWorth({
      safeCash0,
      riskEquity0,
      loanAmount,
      annualReturn,
      annualLoanRate,
      loanYears,
      horizonYears,
      monthlyPayment,
  annualContribution = 0, // æ¯å¹´å›ºå®šæŠ•å…¥é¢¨éšªæ¡¶
  annualSurplus = 0       // æ¯å¹´å¯é‹ç”¨çš„å‰©é¤˜ç¾é‡‘æµï¼ˆæ‰£æ‰ç”Ÿæ´»è²»ï¼‹æœˆä»˜ï¼‰
    }) {
      let safeCash = safeCash0;                  // ğŸ”¹ æ”¹æˆ letï¼Œæœƒé€å¹´ç´¯ç©
  let riskAssets = riskEquity0 + loanAmount; // åˆå§‹æŠ•è³‡è³‡ç”¢
      const rAsset = annualReturn / 100;
      const points = [];

  for (let year = 1; year <= horizonYears; year++) {
    // 1. å¹´åˆå…ˆæŠŠã€Œæ¯å¹´è¿½åŠ æŠ•å…¥ã€æ”¾é€²é¢¨éšªæ¡¶
    if (annualContribution > 0) {
      riskAssets += annualContribution;
    }

    // 2. å‰©é¤˜ç¾é‡‘æµæ‰£æ‰è¿½åŠ æŠ•å…¥å¾Œï¼Œæ”¾é€²å®‰å…¨æ¡¶
    if (annualSurplus > 0) {
      const leftover = Math.max(annualSurplus - annualContribution, 0);
      safeCash += leftover;
    }

    // 3. ç„¶å¾Œæ•´ç­†é¢¨éšªè³‡ç”¢æŒ‰å¹´åŒ–å ±é…¬æˆé•·
    riskAssets *= (1 + rAsset);

    // 4. è¨ˆç®—ç•¶å¹´åº¦å¹´åº•çš„å‰©é¤˜å‚µå‹™
    const debt = loanOutstanding(
      loanAmount,
      annualLoanRate,
      loanYears,
      year,
      monthlyPayment
    );

    const totalAssets = safeCash + riskAssets;
    const netWorth = totalAssets - debt;

        points.push({
      year,
      netWorth,
      totalAssets,
      debt,
      safeCash,
      riskAssets
    });
  }

  return points;
    }

    function renderChart(datasets, horizonYears, loanYears) {
      const ctx = document.getElementById('netWorthChart').getContext('2d');
      const labels = [];
      for (let y = 1; y <= horizonYears; y++) {
        labels.push(`${y}`);
      }

      const colors = [
        { border: 'rgb(16, 185, 129)', bg: 'rgba(16, 185, 129, 0.1)' },
        { border: 'rgb(59, 130, 246)', bg: 'rgba(59, 130, 246, 0.1)' },
        { border: 'rgb(239, 68, 68)', bg: 'rgba(239, 68, 68, 0.1)' }
      ];

      const hasNegative = datasets.some(ds => ds.points.some(p => p.netWorth < 0));

      const chartData = {
        labels,
        datasets: datasets.map((ds, idx) => ({
          label: ds.label,
          data: ds.points.map(p => Math.round(p.netWorth)),
          borderColor: colors[idx].border,
          backgroundColor: colors[idx].bg,
          borderWidth: 2,
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 4
        }))
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          y: {
            ticks: {
              callback: value => value.toLocaleString('zh-TW')
            },
            title: { display: true, text: 'æ·¨è³‡ç”¢ï¼ˆå…ƒï¼‰' },
            grid: {
              color: context =>
                context.tick.value === 0
                  ? 'rgba(0, 0, 0, 0.4)'
                  : 'rgba(0, 0, 0, 0.1)',
              lineWidth: context => (context.tick.value === 0 ? 2 : 1)
            }
          },
          x: {
            title: { display: true, text: 'æŒæœ‰å¹´æ•¸' }
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15
            }
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                let label = context.dataset.label || '';
                if (label) label += ': ';
                label += context.parsed.y.toLocaleString('zh-TW') + ' å…ƒ';
                return label;
              }
            }
          }
        }
      };

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, { type: 'line', data: chartData, options });

      const noteEl = document.getElementById('chartNote');
      let note = '';
      if (loanYears < horizonYears && loanYears > 0) {
        note += `ğŸ’¡ å€Ÿæ¬¾å°‡åœ¨ç¬¬ ${loanYears} å¹´é‚„æ¸…ï¼Œä¹‹å¾Œä¸å†æœ‰è² å‚µã€‚`;
      }
      if (hasNegative) {
        note += (note ? ' ' : '') + 'âš ï¸ æŸäº›æƒ…å¢ƒä¸‹æ·¨è³‡ç”¢ç‚ºè² å€¼ï¼Œè¡¨ç¤ºè² å‚µè¶…éç¸½è³‡ç”¢ï¼Œé¢¨éšªæ¥µé«˜ï¼';
      }
      noteEl.textContent = note;
    }

    function setSummaryCards(cards) {
      const container = document.getElementById('summaryCards');
      container.innerHTML = '';
      if (!cards || cards.length === 0) return;

      cards.forEach(card => {
        const div = document.createElement('div');
        div.className =
          'rounded-xl border p-3 ' +
          (card.level === 'ok'
            ? 'border-emerald-400 bg-emerald-50'
            : card.level === 'warn'
            ? 'border-amber-400 bg-amber-50'
            : 'border-rose-400 bg-rose-50');
        div.innerHTML = `
          <div class="text-xs font-medium text-slate-500">${card.title}</div>
          <div class="mt-1 text-base font-semibold">${card.value}</div>
          <div class="mt-1 text-xs text-slate-600">${card.note}</div>
        `;
        container.appendChild(div);
      });
    }

    function setDetailsPanel(html) {
      document.getElementById('detailsPanel').innerHTML = html;
    }

    function setBalancePanel(snapshot) {
      const container = document.getElementById('balancePanel');
      if (!snapshot) {
        container.innerHTML =
          '<p class="text-sm text-slate-500">è«‹å…ˆåœ¨å·¦å´å®Œæˆè¼¸å…¥ä¸¦åŸ·è¡Œæ¨¡æ“¬ï¼Œä¸­æ€§æƒ…å¢ƒçš„è³‡ç”¢è² å‚µè¡¨æ‰æœƒå‡ºç¾ã€‚</p>';
        return;
      }

      const {
        safeCash0,
        riskAssets0,
        totalAssets0,
        debt0,
        netWorth0,
        safeCashT,
        riskAssetsT,
        totalAssetsT,
        debtT,
        netWorthT,
        horizonYears
      } = snapshot;

      container.innerHTML = `
        <table class="min-w-full text-xs md:text-sm border">
          <thead>
            <tr class="bg-slate-50">
              <th class="border px-2 py-1 text-left">é …ç›®</th>
              <th class="border px-2 py-1 text-right">èµ·é»</th>
              <th class="border px-2 py-1 text-right">${horizonYears} å¹´å¾Œï¼ˆä¸­æ€§æƒ…å¢ƒï¼‰</th>
            </tr>
          </thead>
          <tbody>
            <tr class="bg-slate-50/60">
              <td class="border px-2 py-1 font-medium">è³‡ç”¢</td>
              <td class="border px-2 py-1"></td>
              <td class="border px-2 py-1"></td>
            </tr>
            <tr>
              <td class="border px-2 py-1 pl-6">å®‰å…¨æ¡¶ï¼šç¾é‡‘+å¹´åº¦å‰©é¤˜é‡‘æµï¼é å‚™é‡‘(æŠ•è³‡éƒ¨ä½è®Šç¾)</td>
              <td class="border px-2 py-1 text-right">${Math.round(
                safeCash0
              ).toLocaleString('zh-TW')}</td>
              <td class="border px-2 py-1 text-right">${Math.round(
                safeCashT
              ).toLocaleString('zh-TW')}</td>
            </tr>
            <tr>
              <td class="border px-2 py-1 pl-6">é¢¨éšªæ¡¶ï¼šç¾æœ‰æŠ•è³‡è³‡ç”¢+å€Ÿæ¬¾é¡åº¦æŠ•å…¥+æ¯å¹´è¿½åŠ æŠ•å…¥</td>
              <td class="border px-2 py-1 text-right">${Math.round(
                riskAssets0
              ).toLocaleString('zh-TW')}</td>
              <td class="border px-2 py-1 text-right">${Math.round(
                riskAssetsT
              ).toLocaleString('zh-TW')}</td>
            </tr>
            <tr class="bg-slate-50/60">
              <td class="border px-2 py-1 pl-6 font-medium">è³‡ç”¢åˆè¨ˆ</td>
              <td class="border px-2 py-1 text-right font-medium">${Math.round(
                totalAssets0
              ).toLocaleString('zh-TW')}</td>
              <td class="border px-2 py-1 text-right font-medium">${Math.round(
                totalAssetsT
              ).toLocaleString('zh-TW')}</td>
            </tr>
            <tr class="bg-slate-50/60">
              <td class="border px-2 py-1 font-medium">è² å‚µ</td>
              <td class="border px-2 py-1"></td>
              <td class="border px-2 py-1"></td>
            </tr>
            <tr>
              <td class="border px-2 py-1 pl-6">ä¿¡ç”¨è²¸æ¬¾è² å‚µ</td>
              <td class="border px-2 py-1 text-right">${Math.round(
                debt0
              ).toLocaleString('zh-TW')}</td>
              <td class="border px-2 py-1 text-right">${Math.round(
                debtT
              ).toLocaleString('zh-TW')}</td>
            </tr>
            <tr class="bg-slate-50/60">
              <td class="border px-2 py-1 font-medium">æ·¨è³‡ç”¢ï¼ˆè³‡ç”¢ï¼è² å‚µï¼‰</td>
              <td class="border px-2 py-1 text-right font-medium ${
                netWorth0 < 0 ? 'text-rose-600' : ''
              }">${Math.round(netWorth0).toLocaleString('zh-TW')}</td>
              <td class="border px-2 py-1 text-right font-medium ${
                netWorthT < 0 ? 'text-rose-600' : ''
              }">${Math.round(netWorthT).toLocaleString('zh-TW')}</td>
            </tr>
          </tbody>
        </table>
      `;
    }

    function setConceptPanel({ dsrLevel, emLevel, levLevel, assetName, monthlySurplus }) {
      const container = document.getElementById('conceptContent');

      let tag = '';
      let headline = '';
      let explanation = '';
      const safeAssetName = assetName || 'æŒ‡æ•¸å‹ ETF';

      if (emLevel === 'bad' && (dsrLevel === 'bad' || levLevel === 'bad')) {
        tag = 'âš ï¸ å‚µå‹™æ­£åœ¨é€¼è¿‘ã€Œå£“è¿«æ€§ã€å€åŸŸ';
        headline = 'é å‚™é‡‘ä¸è¶³ï¼Œä¸”ç¾é‡‘æµæˆ–æ§“æ¡¿å£“åŠ›åé«˜ï¼Œé€™ç­†ä¿¡è²¸æ›´åƒæ˜¯å£“åŠ›ä¾†æºï¼Œè€Œä¸æ˜¯å¹«æ‰‹ã€‚';
        explanation = `
          åœ¨ Anderson çš„èªè¨€è£¡ï¼Œå£“è¿«æ€§å‚µå‹™çš„ç‰¹å¾µæ˜¯ï¼šåˆ©æ¯åƒæ‰ä½ æœªä¾†çš„é¸æ“‡æ¬Šã€‚
          ç•¶ç·Šæ€¥é å‚™é‡‘é‚„æ²’è£œé½Šï¼ŒåŒæ™‚å–®ç­† DSR æˆ–æ§“æ¡¿æ¯”å·²ç¶“æ‹‰å¾—å¤ªæ»¿æ™‚ï¼Œå†æŠŠè²¸æ¬¾æ‹¿å»è²· ${safeAssetName}ï¼Œ
          æ¯”è¼ƒå®¹æ˜“åœ¨é‡åˆ°å¤±æ¥­æˆ–å¸‚å ´å¤§è·Œæ™‚ï¼Œè¢«è¿«åœ¨å£æ™‚é»è³£å‡ºï¼Œè®“é€™ç­†å‚µå‹™è®ŠæˆçœŸæ­£çš„å£“åŠ›ã€‚
        `;
      } else if (emLevel === 'bad' || dsrLevel === 'bad' || levLevel === 'bad') {
        tag = 'ğŸŸ¡ ä»‹æ–¼å·¥ä½œæ€§èˆ‡å£“è¿«æ€§ä¹‹é–“çš„ç°å€';
        headline = 'æ¢ä»¶é‚„ä¸åˆ°ã€Œå±éšªåˆ°ä¸è¡Œã€ï¼Œä½†æŸä¸€å´å·²ç¶“æ‹‰å¾—å¤ªç·Šï¼Œéœ€è¦å…ˆå›é ­èª¿æ•´åŸºæœ¬ç›¤ã€‚';
        explanation = `
          åœ¨é€™å€‹å€åŸŸï¼Œé€™ç­†ä¿¡è²¸æš«æ™‚æ²’è¾¦æ³•è¢«è¦–ç‚ºç©©å®šçš„ã€Œå·¥ä½œæ€§å‚µå‹™ã€ã€‚
          åœ¨è£œä¸Šç·Šæ€¥é å‚™é‡‘ã€é™ä½æœˆé‚„æ¬¾å£“åŠ›ã€æˆ–æŠŠæ§“æ¡¿æ¯”æ‹‰å›ä¾†ä¹‹å‰ï¼Œç”¨ä¿¡è²¸æŠ•è³‡ ${safeAssetName}ï¼Œ
          å®¹æ˜“åœ¨é—œéµæ™‚åˆ»å¤±å»å½ˆæ€§ã€‚Anderson æœƒå»ºè­°å…ˆæŠŠå£“è¿«æ€§çš„é¢¨éšªå› å­è™•ç†æ‰ï¼Œå†è«‡ç”¨å‚µå‹™å‰µé€ åƒ¹å€¼ã€‚
        `;
      } else if (dsrLevel === 'warn' || levLevel === 'warn') {
        tag = 'ğŸ” å·¥ä½œæ€§å‚µå‹™ï¼Œæœ‰æ©Ÿæœƒå¾€ã€Œå¢å€¼æ€§ã€ç™¼å±•';
        headline = 'ç¾é‡‘æµèˆ‡é å‚™é‡‘ç‹€æ³é‚„ç®—ç©©ï¼Œä½†æ§“æ¡¿èˆ‡é‚„æ¬¾æ¯”ä¾‹ç•¥é«˜ï¼Œéœ€è¦æŒçºŒç›£æ§ã€‚';
        explanation = `
          é€™ç­†ä¿¡è²¸ç›®å‰æ¯”è¼ƒåƒæ˜¯ã€Œæ¢ä»¶å°šå¯çš„å·¥ä½œæ€§å‚µå‹™ã€ã€‚
          åªè¦ä½ æŒçºŒä¿ç•™è¶³å¤ çš„ç·Šæ€¥é å‚™é‡‘ï¼Œä¸¦ç¶­æŒç©©å®šçš„å·¥ä½œç¾é‡‘æµï¼Œ
          æœªä¾†å°±æœ‰æ©ŸæœƒæŠŠé€™ç­†å‚µå‹™é‹ç”¨åœ¨æ›´å…·çµæ§‹å„ªå‹¢çš„ä½ç½®ï¼Œä¾‹å¦‚é•·æœŸæŒæœ‰ ${safeAssetName}ï¼Œ
          æˆ–ä½œç‚ºæµå‹•æ€§ç·©è¡ï¼Œè€Œä¸æ˜¯çŸ­ç·šæŠ•æ©Ÿã€‚
        `;
      } else {
        tag = 'âœ… æ¥è¿‘ Anderson æ‰€èªªçš„ã€Œå¢å€¼æ€§å‚µå‹™ã€æ¢ä»¶';
        headline =
          'é å‚™é‡‘ã€ç¾é‡‘æµèˆ‡æ§“æ¡¿æ°´ä½éƒ½åœ¨ç›¸å°å¥åº·çš„å€é–“ï¼Œé€™ç­†ä¿¡è²¸æ¯”è¼ƒåƒæ˜¯ä¸€å€‹è¢«è¨­è¨ˆéçš„å·¥å…·ã€‚';
        explanation = `
          åœ¨é€™å€‹ç‹€æ…‹ä¸‹ï¼Œé€™ç­†ä¿¡è²¸ä¸åƒæ˜¯å£“åŠ›ä¾†æºï¼Œè€Œæ¯”è¼ƒåƒæ˜¯è¢«ç´å…¥æ•´é«”è³‡ç”¢è² å‚µè¡¨è¨­è¨ˆçš„ä¸€é¡†æ£‹å­ã€‚
          Anderson æœƒæŠŠé€™é¡å‚µå‹™è¦–ç‚ºï¼šåœ¨ç¢ºä¿ç¾é‡‘æµç©©å®šèˆ‡ç·Šæ€¥é å‚™é‡‘å°±ä½çš„å‰æä¸‹ï¼Œ
          ç”¨ä½æˆæœ¬æ§“æ¡¿å»æ›å–æ›´æœ‰å½ˆæ€§çš„è³‡ç”¢é…ç½®èˆ‡æµå‹•æ€§ã€‚
        `;
      }

      const surplusLine = `
        <p class="text-xs text-slate-300 mt-2">
          ç›®å‰ä¼°è¨ˆæ¯æœˆå‰©é¤˜ç¾é‡‘æµç´„ç‚º ${Math.round(
            monthlySurplus
          ).toLocaleString('zh-TW')} å…ƒï¼Œ
          å¯ä»¥è¦–ç‚ºä½ é¢å°é¢¨éšªæ™‚ã€Œèª¿æ•´æ­¥ä¼ã€çš„ç·©è¡ç©ºé–“ã€‚
        </p>
      `;

      container.innerHTML = `
        <p class="text-sm font-semibold text-emerald-300">${tag}</p>
        <p class="mt-1 text-sm">${headline}</p>
        <p class="text-xs text-slate-200 mt-2 leading-relaxed">
          ${explanation}
        </p>
        ${surplusLine}
      `;
    }

    // ç¯„ä¾‹è³‡æ–™
    document.getElementById('exampleButton').addEventListener('click', () => {
      document.getElementById('annualIncome').value = 1200000;
      document.getElementById('monthlyExpense').value = 40000;
      document.getElementById('existingAssets').value = 400000;
      document.getElementById('existingEmergency').value = 400000;
      document.getElementById('emergencyMonths').value = 10;
      document.getElementById('loanAmount').value = 1000000;
      document.getElementById('loanRate').value = 2.1;
      document.getElementById('loanYears').value = 7;
      document.getElementById('assetName').value = 'å…¨çƒè‚¡ç¥¨æŒ‡æ•¸ ETF';
      document.getElementById('optimisticReturn').value = 10;
      document.getElementById('baseReturn').value = 6;
      document.getElementById('pessimisticReturn').value = 0;
      document.getElementById('horizonYears').value = 30;
      document.getElementById('annualContribution').value = 120000;

      const monthlyExpense = 40000;
      const emergencyMonths = 10;
      const emergencyTarget = monthlyExpense * emergencyMonths;
      const emInfoEl = document.getElementById('emergencyTargetInfo');
      if (emInfoEl) {
        emInfoEl.textContent =
          `ç›®æ¨™ç·Šæ€¥é å‚™é‡‘ï¼š${emergencyTarget.toLocaleString('zh-TW')} å…ƒï¼ˆ` +
          `${monthlyExpense.toLocaleString('zh-TW')} å…ƒ/æœˆ Ã— ${emergencyMonths} å€‹æœˆï¼‰`;
      }

      const monthlyPayment = calcMonthlyPayment(1000000, 2.1, 7);
      const mpInfoEl = document.getElementById('monthlyPaymentInfo');
      if (mpInfoEl) {
        mpInfoEl.textContent =
          `é ä¼°æ¯æœˆæœ¬åˆ©æ”¤é‚„ï¼šç´„ ${Math.round(monthlyPayment).toLocaleString(
            'zh-TW'
          )} å…ƒ / æœˆï¼ˆè²¸æ¬¾ 1,000,000 å…ƒï¼Œå¹´åˆ©ç‡ 2.1%ï¼Œ7 å¹´æœŸæœ¬åˆ©æ”¤é‚„ï¼‰`;
      }
    });

    // åŸ·è¡Œæ¨¡æ“¬
    document.getElementById('runButton').addEventListener('click', () => {
      const annualIncome = getNumberValue('annualIncome');
      const monthlyExpense = getNumberValue('monthlyExpense');
      const existingAssets = getNumberValue('existingAssets');
      const existingEmergency = getNumberValue('existingEmergency');
      const emergencyMonths = getNumberValue('emergencyMonths');
      const loanAmount = getNumberValue('loanAmount');
      const loanRate = getNumberValue('loanRate');
      const loanYears = getNumberValue('loanYears');
      const optimisticReturn = getNumberValue('optimisticReturn');
      const baseReturn = getNumberValue('baseReturn');
      const pessimisticReturn = getNumberValue('pessimisticReturn');
      let horizonYears = getNumberValue('horizonYears') || 30;
      const annualContribution = getNumberValue('annualContribution');
      const assetName =
        document.getElementById('assetName').value.trim() || 'æŒ‡æ•¸å‹ ETF';

      if (loanAmount > 0 && (!loanYears || !loanRate)) {
        alert('æœ‰è¨­å®šå€Ÿæ¬¾é¡åº¦æ™‚ï¼Œè«‹åŒæ™‚å¡«å¯«å¹´é™èˆ‡åˆ©ç‡');
        return;
      }

      if (horizonYears > MAX_YEARS) {
        horizonYears = MAX_YEARS;
        document.getElementById('horizonYears').value = MAX_YEARS;
      }

      const emergencyTarget = monthlyExpense * emergencyMonths;
      const monthlyPayment = calcMonthlyPayment(loanAmount, loanRate, loanYears);

      const emInfoEl = document.getElementById('emergencyTargetInfo');
      if (emInfoEl) {
        if (emergencyTarget > 0) {
          emInfoEl.textContent =
            `ç›®æ¨™ç·Šæ€¥é å‚™é‡‘ï¼š${emergencyTarget.toLocaleString('zh-TW')} å…ƒï¼ˆ` +
            `${monthlyExpense.toLocaleString('zh-TW')} å…ƒ/æœˆ Ã— ${emergencyMonths} å€‹æœˆï¼‰`;
        } else {
          emInfoEl.textContent =
            'è«‹å…ˆè¼¸å…¥ã€Œæœˆæ”¯å‡ºã€èˆ‡ã€Œé å‚™é‡‘ç›®æ¨™æœˆæ•¸ã€ï¼Œé€™è£¡æœƒå¹«ä½ ç®—å‡ºéœ€è¦æº–å‚™çš„ç·Šæ€¥é å‚™é‡‘ç¸½é¡ã€‚';
        }
      }

      const mpInfoEl = document.getElementById('monthlyPaymentInfo');
      if (mpInfoEl) {
        if (monthlyPayment > 0) {
          mpInfoEl.textContent =
            `é ä¼°æ¯æœˆæœ¬åˆ©æ”¤é‚„ï¼šç´„ ${Math.round(monthlyPayment).toLocaleString(
              'zh-TW'
            )} å…ƒ / æœˆï¼ˆè²¸æ¬¾ ${loanAmount.toLocaleString(
              'zh-TW'
            )} å…ƒï¼Œå¹´åˆ©ç‡ ${loanRate}%ï¼Œ${loanYears} å¹´æœŸæœ¬åˆ©æ”¤é‚„ï¼‰`;
        } else {
          mpInfoEl.textContent =
            'è«‹å…ˆè¼¸å…¥ã€Œå€Ÿæ¬¾é¡åº¦ã€åˆ©ç‡èˆ‡å¹´é™ã€ï¼Œé€™è£¡æœƒé¡¯ç¤ºé ä¼°æ¯æœˆæœ¬åˆ©æ”¤é‚„é‡‘é¡ã€‚è¼¸å…¥0å‰‡ä»£è¡¨ç„¡æ§“æ¡¿ã€‚';
        }
      }

      const monthlyIncome = annualIncome / 12;
      const fixedOutflow = monthlyExpense + monthlyPayment;
      const monthlySurplus = monthlyIncome - fixedOutflow;
      const annualSurplus = monthlySurplus * 12;

      const safeCash0 = Math.max(existingEmergency, 0);
      const riskEquity0 = Math.max(existingAssets, 0);
      const riskAssets0 = riskEquity0 + loanAmount;

      const totalAssets0 = safeCash0 + riskAssets0;
      const debt0 = loanAmount;
      const netWorth0 = totalAssets0 - debt0;

      const leverage =
        loanAmount && riskAssets0 > 0 ? loanAmount / riskAssets0 : 0;

      const dsr = monthlyIncome ? monthlyPayment / monthlyIncome : 0;
      const actualEmergencyMonths = monthlyExpense
        ? safeCash0 / monthlyExpense
        : 0;

      const optimisticPoints = simulateNetWorth({
        safeCash0,
        riskEquity0,
        loanAmount,
        annualReturn: optimisticReturn,
        annualLoanRate: loanRate,
        loanYears,
        horizonYears,
        monthlyPayment,
        annualContribution,
  annualSurplus
      });

      const basePoints = simulateNetWorth({
        safeCash0,
        riskEquity0,
        loanAmount,
        annualReturn: baseReturn,
        annualLoanRate: loanRate,
        loanYears,
        horizonYears,
        monthlyPayment,
        annualContribution,
  annualSurplus
      });

      const pessimisticPoints = simulateNetWorth({
        safeCash0,
        riskEquity0,
        loanAmount,
        annualReturn: pessimisticReturn,
        annualLoanRate: loanRate,
        loanYears,
        horizonYears,
        monthlyPayment,
        annualContribution,
  annualSurplus
      });

      function classifyDSR(x) {
        if (x <= 0.3) return 'ok';
        if (x <= 0.5) return 'warn';
        return 'bad';
      }

      function classifyEM(actualMonths, targetMonths) {
        if (actualMonths >= targetMonths && actualMonths >= 6) return 'ok';
        if (actualMonths >= 3) return 'warn';
        return 'bad';
      }

      function classifyLev(lev) {
        if (lev <= 0.3) return 'ok';
        if (lev <= 0.6) return 'warn';
        return 'bad';
      }

      const dsrLevel = classifyDSR(dsr);
      const emLevel = classifyEM(actualEmergencyMonths, emergencyMonths || 6);
      const levLevel = classifyLev(leverage);

      const monthlySurplusRounded = Math.round(monthlySurplus);
      const annualSurplusRounded = Math.round(monthlySurplus * 12);
let surplusValueText = `${monthlySurplusRounded.toLocaleString('zh-TW')} å…ƒ / æœˆ`;
if (monthlySurplusRounded > 0) {
  surplusValueText += `ï¼Œç›¸ç•¶æ–¼ ${annualSurplusRounded.toLocaleString('zh-TW')} å…ƒ / å¹´`;
}


      setSummaryCards([
        {
          title: 'å–®ç­† DSRï¼ˆæœ¬ä¿¡è²¸ï¼‰',
          value: (dsr * 100).toFixed(1) + '%',
          level: dsrLevel,
          note: 'ç´„ç•¶ã€Œé€™ç­†ä¿¡è²¸æœˆä»˜å ä½ æœˆæ”¶å…¥ã€çš„æ¯”ä¾‹ã€‚æ•¸å­—è¶Šä½è¶Šæœ‰é¤˜è£•ã€‚'
        },
        {
          title: 'ç·Šæ€¥é å‚™é‡‘å¯¦éš›æœˆæ•¸',
          value: actualEmergencyMonths.toFixed(1) + ' å€‹æœˆ',
          level: emLevel,
          note: emergencyMonths
            ? `ç›®æ¨™ç‚º ${emergencyMonths} å€‹æœˆï¼Œç›®å‰ç´„ç‚º ${actualEmergencyMonths.toFixed(
                1
              )} å€‹æœˆã€‚`
            : 'å»ºè­°è¨­å®šé å‚™é‡‘ç›®æ¨™æœˆæ•¸ï¼ˆä¾‹å¦‚ 6 å€‹æœˆï¼‰ï¼Œå†æ¯”è¼ƒç›®å‰è³‡ç”¢è¦†è“‹ç¨‹åº¦ã€‚'
        },
        {
          title: 'æ§“æ¡¿æ¯”ï¼ˆå€Ÿæ¬¾ / æŠ•å…¥è³‡ç”¢ï¼‰',
          value: (leverage * 100).toFixed(1) + '%',
          level: levLevel,
          note: 'è¶Šæ¥è¿‘ 100% ä»£è¡¨è¶Šå¤šæ˜¯ã€Œå€Ÿä¾†ã€çš„éŒ¢åœ¨æ‰¿å—å¸‚å ´æ³¢å‹•ã€‚'
        },


{
  title: 'æ¯æœˆå‰©é¤˜ç¾é‡‘æµ',
  value: surplusValueText,
  level:
    monthlySurplus <= 0
      ? 'bad'
      : monthlySurplus < monthlyIncome * 0.1
      ? 'warn'
      : 'ok',
  note: `æœˆæ”¶å…¥ç´„ ${Math.round(
    monthlyIncome
  ).toLocaleString('zh-TW')} å…ƒï¼Œæ‰£é™¤ç”Ÿæ´»è²»èˆ‡é€™ç­†ä¿¡è²¸å¾Œçš„é¤˜è£•ã€‚${
    monthlySurplusRounded > 0
      ? 'å¹´åº¦çµ±è¨ˆå‰©é¤˜ç¾é‡‘æµå¯ç”¨ä¾†é€²è¡Œè³‡ç”¢æŠ•å…¥ã€‚'
      : 'è‹¥ç‚ºè² å€¼ï¼Œä»£è¡¨ç•¶å‰çµæ§‹éœ€è¦èª¿æ•´ï¼Œé¿å…å†æé«˜æ§“æ¡¿ã€‚'
  }`
}

      ]);

      const datasets = [
        { label: 'æ¨‚è§€æƒ…å¢ƒ', points: optimisticPoints },
        { label: 'ä¸­æ€§æƒ…å¢ƒ', points: basePoints },
        { label: 'æ‚²è§€æƒ…å¢ƒ', points: pessimisticPoints }
      ];
      renderChart(datasets, horizonYears, loanYears);

      if (basePoints.length > 0) {
        const last = basePoints[basePoints.length - 1];
        const snapshot = {
          safeCash0,
          riskAssets0,
          totalAssets0,
          debt0,
          netWorth0,
          safeCashT: last.safeCash,
          riskAssetsT: last.riskAssets,
          totalAssetsT: last.totalAssets,
          debtT: last.debt,
          netWorthT: last.netWorth,
          horizonYears
        };
        setBalancePanel(snapshot);
      } else {
        setBalancePanel(null);
      }

      setConceptPanel({
        dsrLevel,
        emLevel,
        levLevel,
        assetName,
        monthlySurplus
      });

      setDetailsPanel(`
        <p class="text-sm">
          ä¸‹æ–¹åœ–è¡¨é¡¯ç¤ºåœ¨æ¨‚è§€ã€ä¸­æ€§ã€æ‚²è§€ä¸‰ç¨®å¹´åŒ–å ±é…¬å‡è¨­ä¸‹ï¼Œ
          ä½ çš„ã€Œè³‡ç”¢ï¼è² å‚µã€æ·¨å€¼åœ¨æœªä¾† ${horizonYears} å¹´çš„è®ŠåŒ–ã€‚
        </p>
        <p class="text-xs text-slate-500 mt-1">
          æ¨¡å‹å‡è¨­ï¼šå®‰å…¨æ¡¶ï¼ˆç¾æœ‰é å‚™é‡‘ï¼‰ç¨ç«‹æ”¾åœ¨ä¸€æ—ä¸åƒèˆ‡æ³¢å‹•ï¼›
          é¢¨éšªæ¡¶ç”±ã€Œç¾æœ‰æŠ•è³‡éƒ¨ä½ï¼‹ä¿¡è²¸é‡‘é¡ã€ï¼Œä»¥åŠä½ è¨­å®šçš„ã€Œæ¯å¹´è¿½åŠ æŠ•å…¥ã€çµ„æˆï¼Œéš¨å¸‚å ´æ¼²è·Œã€‚
        </p>
      `);
    });

    // æ¸…ç©º
    document.getElementById('resetButton').addEventListener('click', () => {
      document
        .querySelectorAll('input')
        .forEach(inp => (inp.value = ''));
      document.getElementById('loanRate').value = 2.1;
      document.getElementById('optimisticReturn').value = 10;
      document.getElementById('baseReturn').value = 6;
      document.getElementById('pessimisticReturn').value = 0;
      document.getElementById('horizonYears').value = 30;

      const emInfoEl = document.getElementById('emergencyTargetInfo');
      if (emInfoEl) {
        emInfoEl.textContent =
          'è«‹å…ˆè¼¸å…¥ã€Œæœˆæ”¯å‡ºã€èˆ‡ã€Œé å‚™é‡‘ç›®æ¨™æœˆæ•¸ã€ï¼Œé€™è£¡æœƒå¹«ä½ ç®—å‡ºéœ€è¦æº–å‚™çš„ç·Šæ€¥é å‚™é‡‘ç¸½é¡ã€‚';
      }

      const mpInfoEl = document.getElementById('monthlyPaymentInfo');
      if (mpInfoEl) {
        mpInfoEl.textContent =
          'è«‹å…ˆè¼¸å…¥ã€Œå€Ÿæ¬¾é¡åº¦ã€åˆ©ç‡èˆ‡å¹´é™ã€ï¼Œé€™è£¡æœƒé¡¯ç¤ºé ä¼°æ¯æœˆæœ¬åˆ©æ”¤é‚„é‡‘é¡ã€‚';
      }

      setSummaryCards([]);
      setBalancePanel(null);
      document.getElementById('chartNote').textContent = '';
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }

      document.getElementById('conceptContent').innerHTML = `
        <p>
          å·¦é‚Šè¼¸å…¥çš„æ˜¯ä½ çš„æ•¸å­—ï¼Œé€™è£¡æœƒç”¨ Anderson çš„ä¸‰ç¨®å‚µå‹™èªè¨€ï¼Œå¹«ä½ ç¿»è­¯é€™ç­†ä¿¡è²¸ç›®å‰æ¯”è¼ƒæ¥è¿‘å“ªä¸€ç¨®ç‹€æ…‹ï¼š
        </p>
        <ul class="list-disc ml-5 space-y-1 text-xs text-slate-200">
          <li><span class="font-medium">å£“è¿«æ€§å‚µå‹™ï¼š</span>åˆ©æ¯åƒæ‰ç¾é‡‘æµã€æ²’æœ‰è³‡ç”¢æˆ–æµå‹•æ€§æ”¯æ’ï¼Œæ˜¯å„ªå…ˆæ¸…é™¤çš„å°è±¡ã€‚</li>
          <li><span class="font-medium">å·¥ä½œæ€§å‚µå‹™ï¼š</span>åƒæˆ¿è²¸ã€å­¸è²¸ï¼Œæœ‰è³‡ç”¢æˆ–äººåŠ›è³‡æœ¬æ”¯æ’ï¼Œè®“ä½ åœ¨äººç”Ÿæ™‚é–“è»¸ä¸Šã€Œå…ˆåšå†æ…¢æ…¢ä»˜ã€ã€‚</li>
          <li><span class="font-medium">å¢å€¼æ€§å‚µå‹™ï¼š</span>åœ¨ç¾é‡‘æµç©©ã€é å‚™é‡‘è¶³ã€è³‡ç”¢è² å‚µè¡¨å¥åº·çš„å‰æä¸‹ï¼Œç”¨å°éƒ¨åˆ†ä½åˆ©å‚µå‹™æ›å–çµæ§‹å„ªå‹¢ï¼ˆç¨…å‹™ã€æµå‹•æ€§ã€é¢¨éšªåˆ†æ•£ï¼‰ã€‚</li>
        </ul>
        <p class="text-xs text-slate-300 mt-2">
          å…ˆè·‘ä¸€æ¬¡æ¨¡æ“¬ï¼Œé€™è£¡å°±æœƒæ ¹æ“šä½ çš„ DSRã€ç·Šæ€¥é å‚™é‡‘èˆ‡æ§“æ¡¿æ¯”ï¼Œæè¿°ã€Œé€™ç­†ä¿¡è²¸æ¯”è¼ƒåƒå“ªä¸€å€ã€ã€‚
        </p>
      `;

      setDetailsPanel(
        '<p class="text-slate-500 text-sm">è«‹å¾ Step 1 é–‹å§‹ä¾åºå¡«å¯«ï¼Œå®Œæˆå¾Œé»ã€ŒåŸ·è¡Œæ¨¡æ“¬ã€ï¼Œæˆ–é»ã€Œç¯„ä¾‹è³‡æ–™ã€å¿«é€Ÿé«”é©—ã€‚</p>'
      );
    });
  </script>
</body>
</html>
